<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ö—Ä–æ—Ç–æ –ë–∏—Ç–≤–∞</title>
  <link rel="stylesheet" href="style.css" />
  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- TON Connect -->
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
</head>
<body>
  <div class="game-container">
    <h1>–ö—Ä–æ—Ç–æ –ë–∏—Ç–≤–∞ üï≥Ô∏è</h1>

    <div class="player-stats">
      <p>–ú–æ—Ä–∫–æ–≤–∫–∏: <span id="carrots">0</span></p>
      <p>–£—Ä–æ–Ω: <span id="damage">1</span></p>
      <p>–£—Ä–æ–≤–µ–Ω—å: <span id="level">1</span></p>
    </div>

    <div class="krot-click" id="krot">
      <img src="assets/krot.png" alt="–ö—Ä–æ—Ç" />
    </div>

    <div class="upgrade-panel">
      <button id="btn-damage" class="upgrade-btn">–£–≤–µ–ª–∏—á–∏—Ç—å —É—Ä–æ–Ω</button>
      <button id="btn-auto" class="upgrade-btn">–ê–≤—Ç–æ-–∫—Ä–æ—Ç (50)</button>
      <button id="btn-ton" class="upgrade-btn">üëõ –ü–æ–¥–∫–ª—é—á–∏—Ç—å TON</button>
    </div>

    <div class="leaderboard">
      <h3>üèÜ –õ–∏–¥–µ—Ä—ã</h3>
      <ul id="leader-list">
        <li>–ó–∞–≥—Ä—É–∑–∫–∞...</li>
      </ul>
    </div>

    <div class="message" id="message"></div>
  </div>

  <script>
    // === Firebase Config (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–π) ===
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "your-project.firebaseapp.com",
      databaseURL: "https://your-project-default-rtdb.firebaseio.com",
      projectId: "your-project",
      appId: "1:1234567890:web:abcdef12345"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // === TON Connect ===
    const tonConnectUI = new TONCONNECT.UI.TonConnectUI({
      manifestUrl: window.location.origin + '/tonconnect-manifest.json'
    });

    // === –ó–≤—É–∫–∏ ===
    const soundClick = new Audio('assets/click.mp3');
    const soundUpgrade = new Audio('assets/upgrade.mp3');
    soundClick.volume = 0.3;
    soundUpgrade.volume = 0.5;

    // === –ò–≥—Ä–æ–∫ ===
    let player = {
      carrots: 0,
      damage: 1,
      autoClick: false,
      autoClickLevel: 0,
      level: 1,
      upgrades: { damage: 0, auto: 0 },
      tonClaimed: false
    };

    const $ = id => document.getElementById(id);

    function loadGame() {
      const saved = localStorage.getItem('krotobitva');
      if (saved) Object.assign(player, JSON.parse(saved));
      updateUI();
    }

    function saveGame() {
      localStorage.setItem('krotobitva', JSON.stringify(player));
      saveToCloud();
    }

    function updateUI() {
      $('carrots').textContent = Math.floor(player.carrots);
      $('damage').textContent = player.damage;
      $('level').textContent = player.level;
      $('btn-damage').disabled = player.carrots < getDamageCost();
      $('btn-auto').disabled = player.carrots < getAutoCost();
    }

    function getDamageCost() {
      return 5 + player.upgrades.damage * 10;
    }

    function getAutoCost() {
      return 50 + player.upgrades.auto * 100;
    }

    // === –ö–ª–∏–∫ ===
    $('krot').addEventListener('click', () => {
      player.carrots += player.damage;
      player.level = Math.floor(Math.log2(player.carrots + 1)) + 1;

      // –≠—Ñ—Ñ–µ–∫—Ç
      const click = document.createElement('div');
      click.className = 'click-effect';
      click.textContent = `-${player.damage}`;
      click.style.left = `${event.clientX - 50}px`;
      click.style.top = `${event.clientY - 100}px`;
      document.body.appendChild(click);
      setTimeout(() => click.remove(), 1000);

      // –ó–≤—É–∫
      soundClick.currentTime = 0;
      soundClick.play();

      updateUI();
      saveGame();
      checkTonReward();
    });

    // === –£–ª—É—á—à–µ–Ω–∏—è ===
    $('btn-damage').addEventListener('click', () => {
      const cost = getDamageCost();
      if (player.carrots >= cost) {
        player.carrots -= cost;
        player.damage += 1;
        player.upgrades.damage++;
        soundUpgrade.play();
        showMsg(`+1 —É—Ä–æ–Ω! üí™`);
        updateUI();
        saveGame();
      }
    });

    $('btn-auto').addEventListener('click', () => {
      const cost = getAutoCost();
      if (player.carrots >= cost) {
        player.carrots -= cost;
        player.autoClickLevel++;
        player.upgrades.auto++;
        if (!player.autoClick) {
          player.autoClick = true;
          startAutoClick();
        }
        soundUpgrade.play();
        showMsg(`–ê–≤—Ç–æ-–∫—Ä–æ—Ç –∑–∞–ø—É—â–µ–Ω! ü§ñ`);
        updateUI();
        saveGame();
      }
    });

    function startAutoClick() {
      setInterval(() => {
        if (player.autoClick) {
          player.carrots += player.damage;
          player.level = Math.floor(Math.log2(player.carrots + 1)) + 1;
          updateUI();
          saveGame();
        }
      }, 1000);
    }

    // === TON ===
    $('btn-ton').addEventListener('click', () => {
      tonConnectUI.openModal();
    });

    function checkTonReward() {
      if (player.level >= 10 && !player.tonClaimed && tonConnectUI.connected) {
        alert('üéÅ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –ø–æ–ª—É—á–∏–ª–∏ 0.01 TON!');
        player.tonClaimed = true;
        saveGame();
      }
    }

    // === –õ–∏–¥–µ—Ä—ã ===
    function saveToCloud() {
      const userId = Telegram.WebApp.initDataUnsafe.user?.id || 'demo';
      db.ref('players/' + userId).set({
        name: Telegram.WebApp.initDataUnsafe.user?.first_name || '–ê–Ω–æ–Ω–∏–º',
        carrots: player.carrots,
        level: player.level
      });
    }

    function loadLeaderboard() {
      db.ref('players').orderByChild('carrots').limitToLast(10).once('value')
        .then(snapshot => {
          const list = $('leader-list');
          list.innerHTML = '';
          const players = [];
          snapshot.forEach(child => players.push({ id: child.key, ...child.val() }));
          players.reverse().forEach((p, i) => {
            const li = document.createElement('li');
            li.textContent = `${i+1}. ${p.name} ‚Äî ${Math.floor(p.carrots)} –º–æ—Ä–∫–æ–≤–æ–∫`;
            list.appendChild(li);
          });
        });
    }

    // –û–±–Ω–æ–≤–ª—è—Ç—å –ª–∏–¥–µ—Ä–æ–≤ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫
    setInterval(loadLeaderboard, 30000);

    function showMsg(text) {
      const msg = $('message');
      msg.textContent = text;
      setTimeout(() => msg.textContent = '', 1500);
    }

    // Telegram
    if (Telegram.WebApp) {
      Telegram.WebApp.expand();
      Telegram.WebApp.ready();
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞
    loadGame();
    loadLeaderboard();
  </script>
</body>
</html>
